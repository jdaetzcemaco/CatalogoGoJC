<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKU Processor - Template & Upload System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #e9ecef;
        }
        
        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 1.1em;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            right: 0;
            height: 3px;
            background: #667eea;
        }
        
        .tab:hover {
            background: #e9ecef;
        }
        
        .tab.active:hover {
            background: white;
        }
        
        .tab-content {
            display: none;
            padding: 40px;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .template-field {
            display: grid;
            grid-template-columns: 250px 180px 150px 100px;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .template-field:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .field-input {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border 0.3s ease;
        }
        
        .field-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .field-type-select {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            font-size: 1em;
            cursor: pointer;
        }
        
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-wrapper input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-success:hover {
            background: #38a169;
        }
        
        .btn-warning {
            background: #ed8936;
            color: white;
        }
        
        .btn-warning:hover {
            background: #dd6b20;
        }
        
        .btn-danger {
            background: #f56565;
            color: white;
        }
        
        .btn-danger:hover {
            background: #e53e3e;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
        }
        
        .template-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e9ecef;
        }
        
        .upload-section {
            text-align: center;
            padding: 60px;
            background: #f8f9fa;
            border-radius: 20px;
            border: 3px dashed #dee2e6;
            transition: all 0.3s ease;
        }
        
        .upload-section:hover {
            border-color: #667eea;
            background: #f3f4f6;
        }
        
        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
            color: #667eea;
        }
        
        .upload-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 15px;
        }
        
        .upload-subtitle {
            font-size: 1.1em;
            color: #6c757d;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .file-label {
            display: inline-block;
            padding: 15px 40px;
            background: #667eea;
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .file-label:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .file-info {
            margin-top: 20px;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 10px;
            color: #2e7d32;
            display: none;
        }
        
        .preview-section {
            margin-top: 30px;
            max-height: 400px;
            overflow: auto;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            display: none;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .preview-table th,
        .preview-table td {
            padding: 10px;
            border: 1px solid #e9ecef;
            text-align: left;
        }
        
        .preview-table th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .preview-table tr {
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .preview-table tr:hover {
            background: #f8f9fa;
        }
        
        .preview-table tr.selected-header {
            background: #667eea;
            color: white;
        }
        
        .row-number {
            background: #e9ecef;
            font-weight: 600;
            text-align: center;
        }
        
        .mapping-container {
            display: grid;
            gap: 20px;
            margin-top: 30px;
        }
        
        .mapping-item {
            display: grid;
            grid-template-columns: 250px 1fr 120px;
            gap: 15px;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .mapping-item label {
            font-weight: 600;
            color: #333;
        }
        
        .status {
            text-align: center;
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 5px;
        }
        
        .status.matched {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .status.manual {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .status.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .final-preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .final-preview-table th,
        .final-preview-table td {
            padding: 12px;
            border: 1px solid #e9ecef;
            text-align: left;
        }
        
        .final-preview-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .pending-cell {
            background: #fff3cd;
            color: #856404;
        }
        
        .manual-cell {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-info {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #90caf9;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .progress {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            min-width: 400px;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        
        @media (max-width: 768px) {
            .template-field {
                grid-template-columns: 1fr;
            }
            
            .mapping-item {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1>üìä SKU Processor System</h1>
            <p>Configure your template and process Excel files</p>
        </div>
        
        <div class="tabs">
            <button class="tab" onclick="switchTab('template')">
                üìã Template Configuration
            </button>
            <button class="tab active" onclick="switchTab('upload')">
                üì§ Upload & Process
            </button>
        </div>
        
        <!-- Template Tab -->
        <div id="template-tab" class="tab-content">
            <div class="section">
                <h2 class="section-title">
                    ‚öôÔ∏è Configure Template Fields
                </h2>
                <p style="margin-bottom: 20px; color: #6c757d;">
                    Add, remove, or modify fields for your SKU template. These fields will be mapped to your Excel file columns.
                </p>
                
                <div id="templateFields"></div>
                
                <button class="btn btn-primary" onclick="addTemplateField()">
                    ‚ûï Add New Field
                </button>
                
                <div class="template-actions">
                    <button class="btn btn-success" onclick="saveTemplate()">
                        üíæ Save Template
                    </button>
                    <button class="btn btn-warning" onclick="loadTemplate()">
                        üìÇ Load Saved Template
                    </button>
                    <button class="btn btn-danger" onclick="resetTemplate()">
                        üîÑ Reset to Default
                    </button>
                    <span id="templateStatus" style="margin-left: 20px; font-weight: bold; color: #48bb78; display: none;"></span>
                </div>
            </div>
        </div>
        
        <!-- Upload Tab -->
        <div id="upload-tab" class="tab-content active">
            <div class="section">
                <div class="upload-section" id="uploadSection">
                    <div class="upload-icon">üìÅ</div>
                    <h2 class="upload-title">Suba su archivo de Excel</h2>
                    <p class="upload-subtitle">
                        Recuerde que debe de llevar los campos referidos para poder crear el SKU.<br>
                        Formatos aceptados: .xlsx, .xls, .csv
                    </p>
                    <label for="dataFile" class="file-label">
                        Seleccionar Archivo
                    </label>
                    <input type="file" id="dataFile" accept=".csv,.xlsx,.xls">
                    <div class="file-info" id="fileInfo"></div>
                </div>
                
                <div class="preview-section" id="headerSelectionSection">
                    <div class="alert alert-info">
                        üìå Haga clic en la fila que contiene los encabezados de sus columnas
                    </div>
                    <table class="preview-table" id="headerPreviewTable"></table>
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-primary" id="confirmHeaderBtn" onclick="confirmHeaderSelection()" disabled>
                            Confirmar Fila de Encabezados
                        </button>
                        <span id="selectedRowInfo" style="margin-left: 15px; font-weight: bold;"></span>
                    </div>
                </div>
                
                <div id="mappingSection" style="display: none;">
                    <h2 class="section-title">
                        üîó Field Mapping
                    </h2>
                    <div class="mapping-container" id="fieldMappingContainer"></div>
                    <div style="margin-top: 30px; text-align: center;">
                        <button class="btn btn-primary" onclick="processData()">
                            Process Data
                        </button>
                        <button class="btn btn-danger" onclick="resetAll()">
                            Start Over
                        </button>
                    </div>
                </div>
                
                <div id="previewSection" style="display: none;">
                    <h2 class="section-title">
                        ‚úÖ Preview & Download
                    </h2>
                    <div class="alert alert-warning" id="warningMessage"></div>
                    <div style="overflow-x: auto;">
                        <table class="final-preview-table" id="previewTable"></table>
                    </div>
                    <div style="margin-top: 30px; text-align: center;">
                        <button class="btn btn-success" onclick="downloadProcessed()">
                            üì• Download Processed File
                        </button>
                        <button class="btn btn-primary" onclick="goBackToMapping()">
                            Back to Mapping
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="overlay" id="overlay"></div>
    <div class="progress" id="progress">
        <h3>Processing...</h3>
        <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar">0%</div>
        </div>
        <p id="progressMessage" style="text-align: center; margin-top: 10px; color: #6c757d;"></p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Default template fields with your specified fields
        const defaultTemplateFields = [
            { name: 'Name PROV', type: 'data', required: true },
            { name: 'NO. PROV', type: 'data', required: true },
            { name: 'Local', type: 'data', required: true },
            { name: 'Propio', type: 'data', required: false },
            { name: 'Consignado', type: 'data', required: false },
            { name: 'CACAR', type: 'data', required: false },
            { name: 'Descripci√≥n espa√±ol', type: 'data', required: true },
            { name: 'Ë•øÁè≠ÁâôËØ≠ÊèèËø∞ / Descri√ß√£o / description spagnol', type: 'data', required: false },
            { name: 'Tipo de producto', type: 'data', required: true },
            { name: 'MODELO PROVEEDOR ‰∫ßÂìÅÂûãÂè∑ / MODELO FORNECEDOR', type: 'data', required: true },
            { name: 'Codigo de barra/ UPC', type: 'data', required: true },
            { name: 'Marca', type: 'data', required: true },
            { name: 'C√≥digo de marca', type: 'data', required: false },
            { name: 'INNER PACK', type: 'data', required: false },
            { name: 'LARGO (M)', type: 'data', required: false },
            { name: 'ANCHO (CM)', type: 'data', required: false },
            { name: 'ALTO (CM)', type: 'data', required: false },
            { name: 'Costo sin IVA', type: 'data', required: true },
            { name: 'Precio Retail', type: 'data', required: true },
            { name: 'Departamento', type: 'data', required: true },
            { name: 'Sub-categoria', type: 'data', required: true },
            { name: 'MOQ/ Cantidad m√≠nima para pedido', type: 'data', required: false }
        ];
        
        let templateFields = [];
        let dataFileData = null;
        let rawDataFileData = null;
        let processedData = null;
        let fieldMappings = {};
        let selectedHeaderRow = -1;

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // Initialize template
        function initializeTemplate() {
            const savedTemplate = localStorage.getItem('skuProcessorTemplate');
            if (savedTemplate) {
                try {
                    templateFields = JSON.parse(savedTemplate);
                    showTemplateStatus('Loaded saved template', 3000);
                } catch (e) {
                    console.error('Error loading saved template:', e);
                    templateFields = JSON.parse(JSON.stringify(defaultTemplateFields));
                }
            } else {
                templateFields = JSON.parse(JSON.stringify(defaultTemplateFields));
            }
            updateTemplateDisplay();
        }

        // Update template display
        function updateTemplateDisplay() {
            const container = document.getElementById('templateFields');
            container.innerHTML = '';
            
            templateFields.forEach((field, index) => {
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'template-field';
                
                fieldDiv.innerHTML = `
                    <input type="text" class="field-input" value="${field.name}" 
                           onchange="updateFieldName(${index}, this.value)" 
                           placeholder="Field name">
                    <select class="field-type-select" onchange="updateFieldType(${index}, this.value)">
                        <option value="data" ${field.type === 'data' ? 'selected' : ''}>Data from file</option>
                        <option value="yesno" ${field.type === 'yesno' ? 'selected' : ''}>Yes/No</option>
                        <option value="text" ${field.type === 'text' ? 'selected' : ''}>Text input</option>
                    </select>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="required-${index}" ${field.required ? 'checked' : ''} 
                               onchange="updateFieldRequired(${index}, this.checked)">
                        <label for="required-${index}">Required</label>
                    </div>
                    <button class="btn btn-danger btn-small" onclick="removeTemplateField(${index})">
                        Remove
                    </button>
                `;
                
                container.appendChild(fieldDiv);
            });
            
            // Auto-save
            if (container.children.length > 0) {
                localStorage.setItem('skuProcessorTemplate', JSON.stringify(templateFields));
            }
        }

        // Template management functions
        function addTemplateField() {
            templateFields.push({ 
                name: `Field ${templateFields.length + 1}`, 
                type: 'data', 
                required: false 
            });
            updateTemplateDisplay();
            showTemplateStatus('Field added', 2000);
        }

        function removeTemplateField(index) {
            if (templateFields.length > 1) {
                templateFields.splice(index, 1);
                updateTemplateDisplay();
                showTemplateStatus('Field removed', 2000);
            } else {
                alert('You must have at least one field in the template');
            }
        }

        function updateFieldName(index, value) {
            templateFields[index].name = value;
            localStorage.setItem('skuProcessorTemplate', JSON.stringify(templateFields));
        }

        function updateFieldType(index, value) {
            templateFields[index].type = value;
            localStorage.setItem('skuProcessorTemplate', JSON.stringify(templateFields));
        }

        function updateFieldRequired(index, value) {
            templateFields[index].required = value;
            localStorage.setItem('skuProcessorTemplate', JSON.stringify(templateFields));
        }

        function saveTemplate() {
            localStorage.setItem('skuProcessorTemplate', JSON.stringify(templateFields));
            showTemplateStatus('‚úì Template saved successfully!', 3000);
        }

        function loadTemplate() {
            const savedTemplate = localStorage.getItem('skuProcessorTemplate');
            if (savedTemplate) {
                templateFields = JSON.parse(savedTemplate);
                updateTemplateDisplay();
                showTemplateStatus('‚úì Template loaded!', 3000);
            } else {
                alert('No saved template found.');
            }
        }

        function resetTemplate() {
            if (confirm('Are you sure you want to reset to the default template?')) {
                templateFields = JSON.parse(JSON.stringify(defaultTemplateFields));
                updateTemplateDisplay();
                showTemplateStatus('‚úì Reset to default template', 3000);
            }
        }

        function showTemplateStatus(message, duration) {
            const statusElement = document.getElementById('templateStatus');
            statusElement.textContent = message;
            statusElement.style.display = 'inline';
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, duration);
        }

        // Progress functions
        function showProgress(message) {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('progress').style.display = 'block';
            document.getElementById('progressMessage').textContent = message || '';
        }

        function hideProgress() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('progress').style.display = 'none';
        }

        function updateProgress(percent, message) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
            if (message) {
                document.getElementById('progressMessage').textContent = message;
            }
        }

        // File processing functions
        function readDataFileForPreview(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { 
                            header: 1,
                            defval: '',
                            blankrows: false 
                        });
                        
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.readAsArrayBuffer(file);
            });
        }

        // Show header selection
        function showHeaderSelectionPreview() {
            const table = document.getElementById('headerPreviewTable');
            table.innerHTML = '';
            
            const rowsToShow = Math.min(15, rawDataFileData.length);
            
            for (let i = 0; i < rowsToShow; i++) {
                const row = rawDataFileData[i];
                const tr = document.createElement('tr');
                tr.dataset.rowIndex = i;
                
                const rowNumTd = document.createElement('td');
                rowNumTd.className = 'row-number';
                rowNumTd.textContent = `Row ${i + 1}`;
                tr.appendChild(rowNumTd);
                
                const colsToShow = Math.min(8, row.length);
                for (let j = 0; j < colsToShow; j++) {
                    const td = document.createElement('td');
                    td.textContent = row[j] || '(empty)';
                    td.title = row[j] || '(empty)';
                    tr.appendChild(td);
                }
                
                if (row.length > 8) {
                    const td = document.createElement('td');
                    td.textContent = `... +${row.length - 8} more`;
                    td.style.fontStyle = 'italic';
                    tr.appendChild(td);
                }
                
                tr.onclick = function() {
                    selectHeaderRow(i);
                };
                
                table.appendChild(tr);
            }
            
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('headerSelectionSection').style.display = 'block';
        }

        function selectHeaderRow(rowIndex) {
            selectedHeaderRow = rowIndex;
            
            const rows = document.querySelectorAll('#headerPreviewTable tr');
            rows.forEach(row => row.classList.remove('selected-header'));
            if (rows[rowIndex]) {
                rows[rowIndex].classList.add('selected-header');
            }
            
            document.getElementById('confirmHeaderBtn').disabled = false;
            document.getElementById('selectedRowInfo').textContent = `Selected: Row ${rowIndex + 1}`;
        }

        function confirmHeaderSelection() {
            if (selectedHeaderRow === -1) return;
            
            showProgress('Processing selected headers...');
            updateProgress(50, 'Extracting column information...');
            
            setTimeout(() => {
                try {
                    const headers = rawDataFileData[selectedHeaderRow].filter(h => h && h.toString().trim() !== '');
                    const rows = [];
                    
                    for (let i = selectedHeaderRow + 1; i < rawDataFileData.length; i++) {
                        const row = rawDataFileData[i];
                        if (!row || row.length === 0) continue;
                        
                        const obj = {};
                        let hasData = false;
                        
                        headers.forEach((header, index) => {
                            const value = row[index];
                            obj[header] = value || '';
                            if (value && value.toString().trim() !== '') {
                                hasData = true;
                            }
                        });
                        
                        if (hasData) {
                            rows.push(obj);
                        }
                    }
                    
                    dataFileData = { headers, rows };
                    updateProgress(100, 'Headers processed successfully!');
                    
                    setTimeout(() => {
                        hideProgress();
                        document.getElementById('headerSelectionSection').style.display = 'none';
                        setupFieldMapping();
                    }, 1000);
                    
                } catch (error) {
                    hideProgress();
                    alert('Error processing headers: ' + error.message);
                }
            }, 500);
        }

        // Smart field matching
        function smartFieldMatch(templateField, dataFields) {
            if (!templateField || !dataFields || !Array.isArray(dataFields)) {
                return null;
            }
            
            const normalize = (str) => {
                if (!str || typeof str !== 'string') return '';
                return str.toLowerCase()
                    .replace(/[^a-z0-9]/g, '')
                    .replace(/\s+/g, '');
            };
            
            const normalizedTemplate = normalize(templateField);
            
            // Special cases
            if (templateField === 'NO. PROV' || templateField === 'NO.PROV') {
                const providerVariations = ['providercode', 'provcode', 'providerno', 'provno', 'code', 'providerid', 'noprov'];
                for (let dataField of dataFields) {
                    if (!dataField) continue;
                    const normalizedData = normalize(dataField);
                    if (providerVariations.includes(normalizedData)) {
                        return dataField;
                    }
                }
            }
            
            // Exact match
            for (let dataField of dataFields) {
                if (!dataField) continue;
                if (dataField.toLowerCase() === templateField.toLowerCase()) {
                    return dataField;
                }
            }
            
            // Normalized match
            for (let dataField of dataFields) {
                if (!dataField) continue;
                if (normalize(dataField) === normalizedTemplate) {
                    return dataField;
                }
            }
            
            return null;
        }

        // Setup field mapping
        function setupFieldMapping() {
            const container = document.getElementById('fieldMappingContainer');
            container.innerHTML = '';
            
            const existingMappings = Object.keys(fieldMappings).length > 0;
            
            templateFields.forEach((field, index) => {
                const mappingDiv = document.createElement('div');
                mappingDiv.className = 'mapping-item';
                
                const label = document.createElement('label');
                label.textContent = field.name;
                label.style.fontWeight = field.required ? 'bold' : 'normal';
                if (field.required) {
                    label.textContent += ' *';
                }
                
                let inputElement = '';
                let statusClass = '';
                let statusText = '';
                
                if (field.type === 'data') {
                    const select = document.createElement('select');
                    select.className = 'field-input';
                    select.style.width = '100%';
                    
                    const pendingOption = document.createElement('option');
                    pendingOption.value = 'PENDING';
                    pendingOption.textContent = 'PENDING - To be filled';
                    select.appendChild(pendingOption);
                    
                    dataFileData.headers.forEach(dataField => {
                        const option = document.createElement('option');
                        option.value = dataField;
                        option.textContent = dataField;
                        select.appendChild(option);
                    });
                    
                    // Check existing or smart match
                    if (existingMappings && fieldMappings[index]) {
                        select.value = fieldMappings[index].value;
                        statusText = fieldMappings[index].value === 'PENDING' ? '‚ö† Pending' : '‚úì Matched';
                        statusClass = fieldMappings[index].value === 'PENDING' ? 'pending' : 'matched';
                    } else {
                        const matchedField = smartFieldMatch(field.name, dataFileData.headers);
                        if (matchedField) {
                            select.value = matchedField;
                            fieldMappings[index] = { type: 'data', value: matchedField };
                            statusText = '‚úì Auto-matched';
                            statusClass = 'matched';
                        } else {
                            select.value = 'PENDING';
                            fieldMappings[index] = { type: 'data', value: 'PENDING' };
                            statusText = '‚ö† Pending';
                            statusClass = 'pending';
                        }
                    }
                    
                    select.onchange = function() {
                        fieldMappings[index] = { type: 'data', value: this.value };
                        updateMappingStatus(index, this.value);
                    };
                    
                    inputElement = select;
                    
                } else if (field.type === 'yesno') {
                    const currentValue = (existingMappings && fieldMappings[index]) ? 
                                       fieldMappings[index].value : 'No';
                    fieldMappings[index] = { type: 'yesno', value: currentValue };
                    
                    const container = document.createElement('div');
                    container.style.display = 'flex';
                    container.style.gap = '15px';
                    container.innerHTML = `
                        <label style="cursor: pointer;">
                            <input type="radio" name="yesno-${index}" value="Yes" 
                                   onchange="updateYesNo(${index}, 'Yes')"
                                   ${currentValue === 'Yes' ? 'checked' : ''}>
                            Yes
                        </label>
                        <label style="cursor: pointer;">
                            <input type="radio" name="yesno-${index}" value="No" 
                                   onchange="updateYesNo(${index}, 'No')"
                                   ${currentValue === 'No' ? 'checked' : ''}>
                            No
                        </label>
                    `;
                    inputElement = container;
                    statusText = '‚úì Manual';
                    statusClass = 'manual';
                    
                } else if (field.type === 'text') {
                    const currentValue = (existingMappings && fieldMappings[index]) ? 
                                       fieldMappings[index].value : '';
                    fieldMappings[index] = { type: 'text', value: currentValue };
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'field-input';
                    input.style.width = '100%';
                    input.placeholder = `Enter ${field.name}`;
                    input.value = currentValue;
                    input.onchange = function() {
                        updateTextInput(index, this.value);
                    };
                    
                    inputElement = input;
                    statusText = '‚úì Manual';
                    statusClass = 'manual';
                }
                
                const status = document.createElement('span');
                status.className = 'status ' + statusClass;
                status.id = `status-${index}`;
                status.textContent = statusText;
                
                mappingDiv.appendChild(label);
                if (inputElement instanceof Node) {
                    mappingDiv.appendChild(inputElement);
                } else {
                    mappingDiv.innerHTML += inputElement;
                }
                mappingDiv.appendChild(status);
                
                container.appendChild(mappingDiv);
            });
            
            document.getElementById('mappingSection').style.display = 'block';
        }

        function updateMappingStatus(index, value) {
            const status = document.getElementById(`status-${index}`);
            if (value === 'PENDING') {
                status.textContent = '‚ö† Pending';
                status.className = 'status pending';
            } else {
                status.textContent = '‚úì Matched';
                status.className = 'status matched';
            }
        }

        function updateYesNo(index, value) {
            fieldMappings[index].value = value;
        }

        function updateTextInput(index, value) {
            fieldMappings[index].value = value;
        }

        // Process data
        function processData() {
            showProgress('Processing data...');
            updateProgress(0, 'Starting processing...');
            
            processedData = [];
            let pendingCount = 0;
            
            dataFileData.rows.forEach((dataRow, rowIndex) => {
                if (rowIndex % 100 === 0) {
                    const percent = Math.round((rowIndex / dataFileData.rows.length) * 100);
                    updateProgress(percent, `Processing row ${rowIndex + 1} of ${dataFileData.rows.length}`);
                }
                
                const processedRow = {};
                
                templateFields.forEach((field, index) => {
                    const mapping = fieldMappings[index];
                    
                    if (mapping.type === 'data') {
                        if (mapping.value === 'PENDING') {
                            processedRow[field.name] = 'PENDING';
                            pendingCount++;
                        } else {
                            processedRow[field.name] = dataRow[mapping.value] || '';
                        }
                    } else if (mapping.type === 'yesno') {
                        processedRow[field.name] = mapping.value;
                    } else if (mapping.type === 'text') {
                        processedRow[field.name] = mapping.value || '';
                    }
                });
                
                processedData.push(processedRow);
            });
            
            updateProgress(100, 'Processing complete!');
            
            setTimeout(() => {
                hideProgress();
                showPreview(pendingCount);
            }, 1000);
        }

        // Show preview
        function showPreview(pendingCount) {
            const previewTable = document.getElementById('previewTable');
            const warningMessage = document.getElementById('warningMessage');
            
            warningMessage.innerHTML = pendingCount > 0 
                ? `‚ö†Ô∏è <strong>Attention:</strong> ${pendingCount} fields marked as PENDING need to be filled.`
                : '‚úÖ <strong>Success!</strong> All fields have been processed successfully.';
            
            previewTable.innerHTML = '';
            
            // Header row
            const headerRow = document.createElement('tr');
            templateFields.forEach(field => {
                const th = document.createElement('th');
                th.textContent = field.name;
                headerRow.appendChild(th);
            });
            previewTable.appendChild(headerRow);
            
            // Data rows
            const rowsToShow = Math.min(10, processedData.length);
            for (let i = 0; i < rowsToShow; i++) {
                const row = document.createElement('tr');
                templateFields.forEach(field => {
                    const td = document.createElement('td');
                    const value = processedData[i][field.name];
                    td.textContent = value;
                    
                    if (value === 'PENDING') {
                        td.className = 'pending-cell';
                    } else if (fieldMappings[templateFields.indexOf(field)].type !== 'data') {
                        td.className = 'manual-cell';
                    }
                    
                    row.appendChild(td);
                });
                previewTable.appendChild(row);
            }
            
            if (processedData.length > 10) {
                const moreRow = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = templateFields.length;
                td.style.textAlign = 'center';
                td.style.fontStyle = 'italic';
                td.textContent = `... and ${processedData.length - 10} more rows`;
                moreRow.appendChild(td);
                previewTable.appendChild(moreRow);
            }
            
            document.getElementById('mappingSection').style.display = 'none';
            document.getElementById('previewSection').style.display = 'block';
        }

        // Download processed file
        function downloadProcessed() {
            try {
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(processedData);
                XLSX.utils.book_append_sheet(wb, ws, 'Processed Data');
                
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                const filename = `processed_sku_data_${timestamp}.xlsx`;
                
                XLSX.writeFile(wb, filename);
            } catch (error) {
                alert('Error downloading file: ' + error.message);
            }
        }

        function goBackToMapping() {
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('mappingSection').style.display = 'block';
        }

        function resetAll() {
            dataFileData = null;
            rawDataFileData = null;
            processedData = null;
            fieldMappings = {};
            selectedHeaderRow = -1;
            
            document.getElementById('dataFile').value = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('headerSelectionSection').style.display = 'none';
            document.getElementById('mappingSection').style.display = 'none';
            document.getElementById('previewSection').style.display = 'none';
        }

        // File upload handler
        document.getElementById('dataFile').addEventListener('change', async (e) => {
            if (!e.target.files[0]) return;
            
            const file = e.target.files[0];
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.innerHTML = `
                <strong>Selected file:</strong> ${file.name}<br>
                <strong>Size:</strong> ${(file.size / 1024).toFixed(2)} KB
            `;
            fileInfo.style.display = 'block';
            
            showProgress('Reading file...');
            
            try {
                rawDataFileData = await readDataFileForPreview(file);
                updateProgress(100, 'File loaded successfully!');
                
                setTimeout(() => {
                    hideProgress();
                    showHeaderSelectionPreview();
                }, 1000);
                
            } catch (error) {
                hideProgress();
                alert('Error reading file: ' + error.message);
                fileInfo.style.display = 'none';
            }
        });

        // Initialize on load
        initializeTemplate();
    </script>
</body>
</html>
